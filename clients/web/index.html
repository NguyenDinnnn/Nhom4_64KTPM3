<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>·ª®NG D·ª§NG H·ªåC TƒÇNG C∆Ø·ªúNG TRONG VI·ªÜC T·ªêI ∆ØU H√ìA ƒê∆Ø·ªúNG ƒêI C·ª¶A ROBOT</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-container">
    <!-- C·ªôt tr√°i - M√¥i tr∆∞·ªùng m√¥ ph·ªèng -->
    <div class="left-column">
        <div class="card simulation-card">
            <div class="card-header">
                <span class="card-icon">ü§ñ</span>
                <span class="card-title">M√¥i Tr∆∞·ªùng M√¥ Ph·ªèng</span>
                <span style="margin-left: auto; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 10px; font-size: 12px;">S·∫µn s·∫µng</span>
            </div>
            
            <div class="grid-container">
                <div class="grid" id="grid"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color robot">ü§ñ</div>
                        <span>Robot</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color goal"></div>
                        <span>M·ª•c ti√™u</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color obstacle"></div>
                        <span>V·∫≠t c·∫£n</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color waypoint"></div>
                        <span>ƒêi·ªÉm trung gian</span>
                    </div>
                </div>
                
                <div id="msg" class="status-message">M√¥i tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c reset</div>
            </div>
        </div>
    </div>

    <!-- C·ªôt ph·∫£i -->
    <div class="right-column">
        <!-- Card k·∫øt h·ª£p ƒëi·ªÅu khi·ªÉn robot v√† thu·∫≠t to√°n -->
        <div class="card combined-control-card">
            <div class="combined-content">
                <!-- Ph·∫ßn ƒëi·ªÅu khi·ªÉn robot -->
                <div class="control-section">
                    <div class="section-header">
                        <span class="card-icon">üéÆ</span>
                        <span class="card-title">ƒêi·ªÅu Khi·ªÉn Robot</span>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-start" onclick="startAutoMove()">‚ñ∂ Auto Move</button>
                        <button class="btn btn-stop" onclick="stopAll()">üõë Stop</button>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-reset" onclick="resetGrid()">üîÑ Reset</button>
                        <button class="btn btn-debug" onclick="toggleDebug()">üîß Debug</button>
                    </div>
                    
                    <div id="manualControls" class="manual-controls" style="display:none;">
                        <h4 style="text-align:center; margin-bottom:10px;">ƒêi·ªÅu khi·ªÉn th·ªß c√¥ng</h4>
                        <div class="direction-buttons">
                            <button class="btn btn-debug" onclick="manualMove('up')">‚Üë</button>
                            <button class="btn btn-debug" onclick="manualMove('right')">‚Üí</button>
                            <button class="btn btn-debug" onclick="manualMove('down')">‚Üì</button>
                            <button class="btn btn-debug" onclick="manualMove('left')">‚Üê</button>
                        </div>
                    </div>
                </div>

                <!-- Ph·∫ßn thu·∫≠t to√°n -->
                <div class="algorithm-section">
                    <div class="section-header">
                        <span class="card-icon">üß†</span>
                        <span class="card-title">Thu·∫≠t To√°n H·ªçc TƒÉng C∆∞·ªùng</span>
                    </div>
                    
                    <div class="algorithm-buttons">
                        <button class="btn-algorithm" onclick="runAlgorithm('MC')">Monte Carlo</button>
                        <button class="btn-algorithm" onclick="runAlgorithm('Q-learning')">Q-Learning</button>
                        <button class="btn-algorithm" onclick="runAlgorithm('A2C')">A2C</button>
                        <button class="btn-algorithm" onclick="runAStar()">A*</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card th·ªëng k√™ -->
        <div class="card stats-card">
            <div class="card-header">
                <span class="card-icon">üìä</span>
                <span class="card-title">Th·ªëng K√™ Hi·ªáu Su·∫•t</span>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">THU·∫¨T TO√ÅN</div>
                    <div class="stat-value" id="current-algorithm">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">REWARD</div>
                    <div class="stat-value" id="current-reward">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">STEP</div>
                    <div class="stat-value" id="current-steps">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">WAYPOINTS</div>
                    <div class="stat-value" id="current-waypoints">-</div>
                </div>
            </div>
            
            <div id="algoResult" class="algo-result" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
let gridSizeX=10, gridSizeY=8;
let robotPos=[0,0], goal=[9,7], obstacles=[], waypoints=[], visitedWaypoints=[];
let autoMoving=false, algoMoving=false;
let intervalId=null;
let debugMode=false;
let currentAlgo=null;

// ------------- Draw Grid ----------------
function drawGridOnce(){
    let grid=document.getElementById("grid");
    grid.style.gridTemplateColumns=`repeat(${gridSizeX},35px)`;
    grid.innerHTML="";
    for(let y=0;y<gridSizeY;y++){
        for(let x=0;x<gridSizeX;x++){
            let cell=document.createElement("div");
            cell.classList.add("cell");
            cell.dataset.x=x; cell.dataset.y=y;
            if(obstacles.some(o=>o[0]===x&&o[1]===y)) cell.classList.add("obstacle");
            if(waypoints.some(w=>w[0]===x&&w[1]===y) && !visitedWaypoints.some(vw=>vw[0]===w[0] && vw[1]===w[1])) 
                cell.classList.add("waypoint");
            if(x===goal[0]&&y===goal[1]) cell.classList.add("goal");
            if(x===robotPos[0]&&y===robotPos[1]) {
                cell.classList.add("robot");
                cell.innerHTML = "ü§ñ"; // Th√™m icon robot
            }
            grid.appendChild(cell);
        }
    }
}

// ------------- Update Robot ----------------
function updateRobot(prevPos, newPos){
    let grid=document.getElementById("grid");
    let oldCell=grid.querySelector(`.cell[data-x='${prevPos[0]}'][data-y='${prevPos[1]}']`);
    if(oldCell) {
        oldCell.classList.remove("robot");
        oldCell.innerHTML = ""; // X√≥a icon robot kh·ªèi √¥ c≈©
    }
    let newCell=grid.querySelector(`.cell[data-x='${newPos[0]}'][data-y='${newPos[1]}']`);
    if(newCell) {
        newCell.classList.add("robot");
        newCell.innerHTML = "ü§ñ"; // Th√™m icon robot v√†o √¥ m·ªõi
    }

    waypoints.forEach(w=>{
        if(w[0]===newPos[0] && w[1]===newPos[1]){
            newCell.classList.remove("waypoint");
            newCell.classList.add("visited");
            newCell.innerHTML = "ü§ñ"; // Gi·ªØ icon robot khi ƒëi qua waypoint
            if(!visitedWaypoints.some(vw=>vw[0]===w[0] && vw[1]===w[1])) visitedWaypoints.push([w[0],w[1]]);
        }
    });
}

// ------------- Update Status Message ----------------
function updateStatus(message, type = 'info') {
    const msgElement = document.getElementById("msg");
    msgElement.innerText = message;
    msgElement.className = `status-message ${type}`;
}

// ------------- Update Stats ----------------
function updateStats(algorithm = '-', reward = '-', steps = '-', waypoints = '-') {
    document.getElementById('current-algorithm').innerText = algorithm;
    document.getElementById('current-reward').innerText = reward;
    document.getElementById('current-steps').innerText = steps;
    document.getElementById('current-waypoints').innerText = waypoints;
}

// ------------- Auto Move ----------------
async function startAutoMove(){
    if(autoMoving) return;
    stopAll();
    autoMoving=true; 
    document.getElementById("msg").innerText="Auto move ƒëang t√≠nh to√°n ƒë∆∞·ªùng ƒëi...";
    
    try{
        // G·ªçi API auto_run ƒë·ªÉ t√≠nh to√°n ƒë∆∞·ªùng ƒëi t·ª± ƒë·ªông
        const resp = await fetch("http://127.0.0.1:8000/auto_run", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({})
        });
        const data = await resp.json();
        
        if(data.error){ 
            document.getElementById("msg").innerText = `L·ªói: ${data.error}`;
            autoMoving = false;
            return; 
        }

        document.getElementById("msg").innerText = "Auto move ƒëang ch·∫°y...";
        let path = data.path;
        let currentStep = 0;
        
        // Animate qua t·ª´ng b∆∞·ªõc trong path
        intervalId = setInterval(() => {
            if(!autoMoving || currentStep >= path.length) {
                clearInterval(intervalId);
                intervalId = null;
                if(autoMoving) {
                    autoMoving = false;
                    document.getElementById("msg").innerText = data.done ? 
                        "üéâ Auto move ho√†n th√†nh! Robot ƒë√£ ƒë·∫øn ƒë√≠ch" : 
                        "Auto move ho√†n th√†nh";
                }
                return;
            }
            
            let prevPos = currentStep > 0 ? path[currentStep-1] : [0,0];
            let currentPos = path[currentStep];
            robotPos = currentPos;
            visitedWaypoints = data.visited_waypoints || [];
            updateRobot(prevPos, currentPos);
            
            currentStep++;
        }, 300); // 300ms m·ªói b∆∞·ªõc nh∆∞ code g·ªëc
        
    } catch(e) {
        console.error(e);
        document.getElementById("msg").innerText = "C√≥ l·ªói khi ch·∫°y Auto move";
        autoMoving = false;
    }
}

// ------------- STOP ----------------
function stopAll(){
    autoMoving=false; algoMoving=false; currentAlgo=null;
    if(intervalId) clearInterval(intervalId);
    intervalId=null;
    document.getElementById("msg").innerText="ƒê√£ d·ª´ng robot";
    document.getElementById("algoResult").style.display = "none";
}

// ------------- Reset Grid ----------------
async function resetGrid(){
    stopAll();
    let resp=await fetch("http://127.0.0.1:8000/reset",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}"});
    let data=await resp.json();
    robotPos=data.state; goal=data.map.goal; obstacles=data.map.obstacles; waypoints=data.map.waypoints||[];
    visitedWaypoints=[];
    gridSizeX=data.map.width; gridSizeY=data.map.height;
    drawGridOnce();
    updateRobot([0,0],robotPos);
    document.getElementById("msg").innerText="";
    updateStats();
    document.getElementById("algoResult").style.display = "none";
}

// ------------- Manual Move ----------------
async function manualMove(dir){
    if(!debugMode) return;
    let prevPos=[...robotPos];
    let resp=await fetch("http://127.0.0.1:8000/step",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action_name:dir})});
    let data=await resp.json();
    if(!data.error){
        robotPos=data.state; visitedWaypoints=data.visited_waypoints||[];
        updateRobot(prevPos,robotPos);
    }
}

function toggleDebug(){
    debugMode=!debugMode; 
    document.getElementById("manualControls").style.display=debugMode?"block":"none";
}

// ------------- RL Algorithms ----------------
async function runAlgorithm(algo){
    stopAll(); algoMoving=true; currentAlgo=algo;
    updateStatus(`ƒêang ch·∫°y ${algo}...`, "running");
    updateStats(algo, "ƒêang t√≠nh...", "ƒêang t√≠nh...", "ƒêang t√≠nh...");
    
    const resultDiv = document.getElementById("algoResult");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `<div class="loading"></div> ƒêang ch·∫°y thu·∫≠t to√°n ${algo}...`;

    intervalId=setInterval(async()=>{
        if(!algoMoving || !currentAlgo){ clearInterval(intervalId); return; }
        try{
            const resp=await fetch("http://127.0.0.1:8000/run_algorithm",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({algorithm:currentAlgo})});
            const data=await resp.json();
            if(data.error){ 
                updateStatus(`L·ªói: ${data.error}`, "error");
                resultDiv.innerHTML = `‚ùå L·ªói: ${data.error}`;
                stopAll(); clearInterval(intervalId); 
                return; 
            }

            let prevPos=[...robotPos];
            robotPos=data.state; visitedWaypoints=data.visited_waypoints||[];
            updateRobot(prevPos,robotPos);

            let saveApi = "";
            if(algo==="Q-learning") saveApi = "/save_qlearning";
            else if(algo==="MC") saveApi = "/save_mc";
            else if(algo==="A2C") saveApi = "/save_a2c";
            if(saveApi) await fetch("http://127.0.0.1:8000"+saveApi, {method:"POST"});

            // Update stats
            updateStats(
                data.algorithm,
                data.reward.toFixed(1),
                data.steps,
                `${data.visited_waypoints.length}/${waypoints.length}`
            );

            resultDiv.innerHTML = `
                ‚úÖ <strong>${data.algorithm}</strong><br>
                üéØ Reward: ${data.reward.toFixed(1)}<br>
                üë£ Steps: ${data.steps}<br>
                üìç Waypoints: ${data.visited_waypoints.length}/${waypoints.length}<br>
                ${data.done ? "üèÜ <strong>Robot ƒë√£ ƒë·∫øn ƒë√≠ch!</strong>" : "üîÑ ƒêang t√¨m ƒë∆∞·ªùng..."}
            `;

            if(data.done){ 
                stopAll(); 
                clearInterval(intervalId);
                updateStatus("üéâ Ho√†n th√†nh! Robot ƒë√£ ƒë·∫øn ƒë√≠ch", "success");
            }
        }catch(e){ 
            console.error(e); 
            updateStatus("C√≥ l·ªói khi g·ªçi thu·∫≠t to√°n", "error");
            resultDiv.innerHTML = "‚ùå C√≥ l·ªói x·∫£y ra khi ch·∫°y thu·∫≠t to√°n";
            stopAll(); clearInterval(intervalId); 
        }
    },200);
}

// ------------- Run A* ----------------
async function runAStar(){
    stopAll();
    updateStatus("ƒêang ch·∫°y A*...", "running");
    updateStats("A*", "ƒêang t√≠nh...", "ƒêang t√≠nh...", "ƒêang t√≠nh...");
    
    const resultDiv = document.getElementById("algoResult");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `<div class="loading"></div> ƒêang ch·∫°y thu·∫≠t to√°n A*...`;
    
    try{
        const resp = await fetch("http://127.0.0.1:8000/run_a_star",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});
        const data = await resp.json();
        if(data.error){ 
            updateStatus(`L·ªói: ${data.error}`, "error");
            resultDiv.innerHTML = `‚ùå L·ªói: ${data.error}`;
            return; 
        }

        let path = data.path;
        for(let i=1;i<path.length;i++){
            await new Promise(r=>setTimeout(r,200));
            let prevPos = [...robotPos];
            robotPos = path[i];
            visitedWaypoints = data.visited_waypoints||[];
            updateRobot(prevPos, robotPos);
        }

        updateStats(
            data.algorithm,
            data.reward.toFixed(1),
            data.steps,
            `${data.visited_waypoints.length}/${waypoints.length}`
        );

        resultDiv.innerHTML = `
            ‚úÖ <strong>${data.algorithm}</strong><br>
            üéØ Reward: ${data.reward.toFixed(1)}<br>
            üë£ Steps: ${data.steps}<br>
            üìç Waypoints: ${data.visited_waypoints.length}/${waypoints.length}<br>
            ${data.done ? "üèÜ <strong>Robot ƒë√£ ƒë·∫øn ƒë√≠ch!</strong>" : ""}
        `;

        updateStatus("üéâ A* ho√†n th√†nh!", "success");

    }catch(e){ 
        console.error(e); 
        updateStatus("C√≥ l·ªói khi ch·∫°y A*", "error");
        resultDiv.innerHTML = "‚ùå C√≥ l·ªói x·∫£y ra khi ch·∫°y A*";
    }
}

// Kh·ªüi t·∫°o
resetGrid();
</script>
</body>
</html>
